---
title:  Make CI fast again
date: 2017-04-05
author: Benjamin Lewis
github: 23inhouse
---

In October 2016 we started using CircleCI. Our build
times started out at about 10 minutes but as time went by they slowely crept up
to 15 minutes. Our deploys were blocked by the agony of waiting an eternity.
Luckily we do have hundreds of nerf bullets to pass the time.

CircleCI recently introduced version 2.0 beta and we decided to give it a try.
Version 2.0 has more generic options allowing for more control and flexibility.
Using the new configuration lowered our build times to below 5 minutes.
Waiting for a build is like waiting for a train; anything more than five minutes
and I'll just walk.

![build performance](/img/make-ci-fast-again/build-performance.png "Build Performance")

## Overview

We sped up our build times by:

 * Caching the bundle install, asset precompile and phantomjs install
 * Reusing the cached assets in both the tests and docker build
 * Running the tests in parallel
 * Caching the docker build

The Cicle CI 2.0 docs are still in development but are very good.

 * Migration guide - https://circleci.com/docs/2.0/migrating-from-1-2/
 * Configuration options - https://circleci.com/docs/2.0/configuration-reference/
 * Docker build caching - https://circleci.com/docs/2.0/docker-layer-caching/
 * Parallelism - https://circleci.com/docs/2.0/parallelism-faster-jobs/
 * Community forum - https://discuss.circleci.com/search?q=2.0%20support

### Circe CI 2.0 config - for your copy pasting pleasure

```yml
version: 2
jobs:
  build:
    docker:
      - image: ruby:2.3.3
        environment:
          CODECLIMATE_REPO_TOKEN: 532937
          RAILS_ENV: test
          PHANTOMJS_VERSION: 2.1.1
      - image: mdillon/postgis:9.4
        environment:
          POSTGRES_USER: root
      - image: redis

    working_directory: /app

    parallelism: 4

    steps:
      - checkout
      - run:
          name: Setup hosts
          command: echo 127.0.0.1 test.fromatob.com | tee -a /etc/hosts

      # Apt-get install
      - run:
          name: Apt-get - Install
          command: >
            apt-get update -qq &&
            apt-get install -y build-essential libpq-dev \
              postgresql-client-9.4 libfontconfig wget nodejs

      # Phantomjs install
      - restore_cache:
          name: PhantomJS - Restore cache
          key: phantomjs-2-1-1
      - run:
          name: PhantomJS - Install dependencies
          command: |
            [ -f /usr/local/bin/phantomjs ] || apt-get update
            [ -f /usr/local/bin/phantomjs ] || apt-get install -y fontconfig wget
      - run:
          name: PhantomJS - Install
          command: |
            [ -f /usr/local/bin/phantomjs ] || wget -O \
              /tmp/phantomjs.tar.bz2 https://github.com/Medium/phantomjs/releases/download/v${PHANTOMJS_VERSION}/phantomjs-${PHANTOMJS_VERSION}-linux-x86_64.tar.bz2
            [ -f /usr/local/bin/phantomjs ] || tar -xjf /tmp/phantomjs.tar.bz2 -C /tmp
            [ -f /usr/local/bin/phantomjs ] ||
              mv /tmp/phantomjs-${PHANTOMJS_VERSION}-linux-x86_64/bin/phantomjs \
              /usr/local/bin/phantomjs
      - save_cache:
          name: PhantomJS - Save cache
          key: phantomjs-2-1-1
          paths:
            - /usr/local/bin/phantomjs

      # Bundle install
      - restore_cache:
          name: Bundle - Restore cache
          key: bundle-cache-{{ checksum "Gemfile.lock" }}
      - run:
          name: Bundle - Install gems
          command: bundle install --path /vendor/bundle
      - save_cache:
          name: Bundle - Save cache
          key: bundle-cache-{{ checksum "Gemfile.lock" }}
          paths:
            - /vendor/bundle

      # Precomplie assets
      - run:
          name: Assets - Save md5sum
          command: |
            echo $(tar --mtime='1970-01-01' -c app/assets/ | md5sum) >
              /tmp/app-assets-md5sum.txt
      - restore_cache:
          name: Assets - Restore cache
          key: asset-cache-{{ checksum "/tmp/app-assets-md5sum.txt" }}
      - run:
          name: Assets - Precompile
          command: |
            [ -d /app/public/columbus-assets ] ||
              bundle exec rake assets:precompile RAILS_ENV=production
      - save_cache:
          name: Assets - Save cache
          key: asset-cache-{{ checksum "/tmp/app-assets-md5sum.txt" }}
          paths:
            - /app/public/columbus-assets

      # Prepare the DB
      - run:
          name: Load schema
          command: bundle exec rake db:create db:structure:load db:migrate

      # Run the tests
      - run:
          name: Run feature specs
          command: |
            bundle exec rspec -r rspec_junit_formatter --format progress \
              --format RspecJunitFormatter -o /tmp/test-results/rspec-feature.xml \
              $(
                circleci tests glob "spec/{requests,features}/**/*_spec.rb" |
                circleci tests split --split-by=timings --timings-type=filename
              )
      - run:
          name: Run unit specs
          command: |
            bundle exec rspec -r rspec_junit_formatter --format progress \
              --format RspecJunitFormatter -o /tmp/test-results/rspec-unit.xml \
              $(
                circleci tests glob "spec/{controllers,errors,facades,helpers,jobs,lib,mailers,models,presenters,routing,services,views}/**/*_spec.rb" |
                circleci tests split --split-by=timings --timings-type=filename
              )
      - run:
          name: Run tests
          command: |
            bundle exec rake test \
              $(circleci tests glob "test/**/*_test.rb" | circleci tests split) \
              TESTOPTS="--ci-dir=/tmp/test-results"
      - store_test_results:
          path: /tmp/test-results

      - setup_remote_docker:
          reusable: true
          exclusive: true

      - deploy:
          name: Docker - Install
          command: |
            set -x
            VER="17.03.0-ce"
            curl -L -o \
              /tmp/docker-$VER.tgz https://get.docker.com/builds/Linux/x86_64/docker-$VER.tgz
            tar -xz -C /tmp -f /tmp/docker-$VER.tgz
            mv /tmp/docker/* /usr/bin
      - deploy:
          name: Docker - Build and tag image
          command: |
            SAFE_BRANCH=$(echo $CIRCLE_BRANCH | sed 's/\//-/g')
            docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
            docker build -f Dockerfile.deploy -t \
              "fromatob/columbus:${SAFE_BRANCH}-${CIRCLE_SHA1:0:7}" .
            if [[ "${SAFE_BRANCH}" == "master" ]]; then
              docker tag "fromatob/columbus:${SAFE_BRANCH}-${CIRCLE_SHA1:0:7}" \
                "fromatob/columbus:stable"
            fi
      - deploy:
          name: Docker - Push image
          command: docker push fromatob/columbus
      - deploy:
          name: Notify slack
          command: |
            SAFE_BRANCH=$(echo $CIRCLE_BRANCH | sed 's/\//-/g')
            if [[ "${SAFE_BRANCH}" == "master" ]]; then
              curl -X POST -H "Content-type: application/json" \
                --data "{\"text\":\"received image \`fromatob/columbus:${SAFE_BRANCH}-${CIRCLE_SHA1:0:7}\` by ${CIRCLE_USERNAME}\"}" https://hooks.slack.com/services/OUrSeCrEtcODE
            fi
            curl -X POST -H "Content-type: application/json" \
              --data "{\"text\":\"received image \`fromatob/columbus:${SAFE_BRANCH}-${CIRCLE_SHA1:0:7}\`\"}" https://hooks.slack.com/services/OUrSeCrEtcODE
```

## CircleCI 2.0 auto caching

CircleCI does a lot of automatic caching. It wasn't necessary to cache this
step. It normally only takes about 8 seconds.

```yml
version: 2
jobs:
  build:
    steps:
      # Apt-get install
      - run:
          name: Apt-get - Install
          command: >
            apt-get update -qq &&
            apt-get install -y build-essential libpq-dev \
              postgresql-client-9.4 libfontconfig wget nodejs
```

## Caching all the other things

Caching the bundle install is pretty straight forward. The cache key is
created from a checksum of the Gemlock file. Bundle uses the pre installed
gems in that path.

```yml
version: 2
jobs:
  build:
    steps:
      # Bundle install
      - restore_cache:
          name: Bundle - Restore cache
          key: bundle-cache-{{ checksum "Gemfile.lock" }}
      - run:
          name: Bundle - Install gems
          command: bundle install --path /vendor/bundle
      - save_cache:
          name: Bundle - Save cache
          key: bundle-cache-{{ checksum "Gemfile.lock" }}
          paths:
            - /vendor/bundle
```

Compiling the assests was a bit more complicated. The recommended approach is
to have fallback caches as described here.
https://circleci.com/docs/2.0/configuration-reference/#savecache
The problem with this approach is precompiling still has to run every time. We
have too many assets so our approach is to cache assets and only recompile if
any of the `app/assets` changed. The downside of this approach is if any of the
assets change they all get recompiled. We achived this by creating an md5sum of
a tar of the `app/assets` directory. This md5sum file is used with circle's
checksum function.

_note:_ We changed our test environment to use the production assets path so
the assets don't get compiled when running the tests.

```yml
version: 2
jobs:
  build:
    steps:
      # Precomplie assets
      - run:
          name: Assets - Save md5sum
          command: echo $(tar --mtime='1970-01-01' -c app/assets/ | md5sum) > /tmp/app-assets-md5sum.txt
      - restore_cache:
          name: Assets - Restore cache
          key: asset-cache-{{ checksum "/tmp/app-assets-md5sum.txt" }}
      - run:
          name: Assets - Precompile
          command: |
            [ -d /app/public/columbus-assets ] || bundle exec rake assets:precompile RAILS_ENV=production
      - save_cache:
          name: Assets - Save cache
          key: asset-cache-{{ checksum "/tmp/app-assets-md5sum.txt" }}
          paths:
            - /app/public/columbus-assets
      - run:
          name: Assets - Remove md5sum
          command: rm /tmp/app-assets-md5sum.txt
```


## Parallelism

Cirle CI lets you scale up the number of containers. We used this option in the
running the tests section.

```yml
version: 2
jobs:
  build:
    parallelism: 4
```

We optimized the spec and test runs to take advantage of parallelism. We also
refactored our very slow running feature spec files into multiple files so they
could be run in different containers.

```yml
version: 2
jobs:
  build:
    steps:
      # Run the tests
      - run:
          name: Run feature specs
          command: |
            bundle exec rspec -r rspec_junit_formatter --format progress \
              --format RspecJunitFormatter -o /tmp/test-results/rspec-feature.xml \
              $(
                circleci tests glob "spec/{requests,features}/**/*_spec.rb" |
                circleci tests split --split-by=timings --timings-type=filename
              )
      - run:
          name: Run unit specs
          command: |
            bundle exec rspec -r rspec_junit_formatter --format progress \
              --format RspecJunitFormatter -o /tmp/test-results/rspec-unit.xml \
              $(
                circleci tests glob "spec/{controllers,errors,facades,helpers,jobs,lib,mailers,models,presenters,routing,services,views}/**/*_spec.rb" |
                circleci tests split --split-by=timings --timings-type=filename
              )
      - run:
          name: Run tests
          command: |
            bundle exec rake test \
              $(circleci tests glob "test/**/*_test.rb" | circleci tests split) \
              TESTOPTS="--ci-dir=/tmp/test-results"
      - store_test_results:
          path: /tmp/test-results
```



## Caching the docker build and push

Circle has an option to turn on docker layer caching. This feature has to be
requested.

```yml
version: 2
jobs:
  build:
    steps:
      - setup_remote_docker:
          reusable: true
          exclusive: true
```

## Bonus step

Slack all the things! We notify slack when the image is available.

```yml
version: 2
jobs:
  build:
    steps:
      - deploy:
          name: Notify slack
          command: |
            SAFE_BRANCH=$(echo $CIRCLE_BRANCH | sed 's/\//-/g')
            if [[ "${SAFE_BRANCH}" == "master" ]]; then
              curl -X POST -H "Content-type: application/json" --data "{\"text\":\"received image \`fromatob/columbus:${SAFE_BRANCH}-${CIRCLE_SHA1:0:7}\` by ${CIRCLE_USERNAME}\"}" https://hooks.slack.com/services/OUrSeCrEtcODE
            fi
            curl -X POST -H "Content-type: application/json" --data "{\"text\":\"received image \`fromatob/columbus:${SAFE_BRANCH}-${CIRCLE_SHA1:0:7}\`\"}" https://hooks.slack.com/services/OUrSeCrEtcODE
```

## Conclusion

The teams deployment behaviour has already changed. The PRs are smaller and
everybody is deploying more frequently. I was a hero for the day!


_Want to work with Ben? <a href="mailto:join-our-team@fromatob.com">Say Hi!</a>_
